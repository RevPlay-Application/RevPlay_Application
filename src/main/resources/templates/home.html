<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>RevPlay - Stream Your Favorite Music</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a th:href="@{/}" class="navbar-brand">ðŸŽµ REVPLAY</a>
        <div class="nav-links">
            <a th:href="@{/}">Home</a>

            <div sec:authorize="isAuthenticated()">
                <a th:href="@{/user/favorites}">Favorites</a>
                <a th:href="@{/user/playlists}">Playlists</a>
                <a th:href="@{/user/history}">History</a>

                <div class="profile-menu">
                    <div class="profile-circle" th:if="${currentUser != null && currentUser.profileImage != null}">
                        <img th:src="@{/user/profile-image/{id}(id=${currentUser.userId})}"
                            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="profile-circle" th:if="${currentUser == null || currentUser.profileImage == null}"
                        th:text="${#authentication.name != null && #authentication.name.length() > 0 ? #authentication.name.substring(0,1).toUpperCase() : 'U'}">
                        U</div>
                    <div class="profile-dropdown">
                        <a th:href="@{/artist/dashboard}" sec:authorize="hasRole('ARTIST')">Dashboard</a>
                        <a th:href="@{/artist/settings}" sec:authorize="hasRole('ARTIST')">Settings</a>
                        <!-- If user role needs settings, we need a user settings page too. For now linking artist settings as requested. -->
                        <a th:href="@{/logout}">Logout</a>
                    </div>
                </div>
            </div>

            <a th:href="@{/login}" sec:authorize="!isAuthenticated()">Login</a>
            <a th:href="@{/register}" sec:authorize="!isAuthenticated()">Register</a>
        </div>
    </nav>

    <div class="container" id="main-content">
        <h1>Welcome to RevPlay</h1>

        <form th:action="@{/songs/search}" method="get" style="margin-bottom: 2rem; display: flex; gap: 1rem;">
            <input type="text" name="query" class="form-control" placeholder="Search for songs or artists..." required>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <div class="content-sections" style="display: flex; gap: 2rem; margin-top: 3rem; flex-wrap: wrap;">
            <!-- Songs Section -->
            <div class="songs-section" style="flex: 1; min-width: 300px;">
                <h2
                    style="font-size: 1.2rem; border-bottom: 2px solid var(--primary); display: inline-block; margin-bottom: 1rem;">
                    Songs</h2>
                <p th:if="${songs == null || songs.empty}">No songs available yet.</p>
                <div class="song-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.8rem;">
                    <div th:each="song : ${songs}" class="card" style="padding: 0.8rem;">
                        <img th:src="@{/songs/cover/{id}(id=${song.songId})}"
                            onerror="this.src='/images/music-placeholder.svg'" alt="Cover"
                            style="width: 100%; border-radius: 4px; margin-bottom: 0.5rem; aspect-ratio: 1; object-fit: cover;">
                        <h3 th:text="${song.title}" style="font-size: 0.9rem; margin: 0;">Song Title</h3>
                        <p th:text="${song.artist != null ? song.artist.artistName : 'Unknown Artist'}"
                            style="color: var(--text-secondary); font-size: 0.75rem; margin: 0.2rem 0;">Artist Name</p>
                        <button class="btn btn-primary play-btn" th:data-id="${song.songId}"
                            th:data-title="${song.title}"
                            th:data-artist="${song.artist != null ? song.artist.artistName : 'Unknown Artist'}"
                            th:data-album-id="${song.album != null ? song.album.albumId : 'null'}"
                            style="width: 100%; margin-top: 0.5rem; font-size: 0.7rem; padding: 0.4rem;">Play</button>
                    </div>
                </div>
            </div>

            <!-- Albums Section -->
            <div class="albums-section" style="flex: 1; min-width: 300px;">
                <h2
                    style="font-size: 1.2rem; border-bottom: 2px solid var(--primary); display: inline-block; margin-bottom: 1rem;">
                    Albums</h2>
                <p th:if="${albums == null || albums.empty}">No albums available yet.</p>
                <div class="album-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.8rem;">
                    <div th:each="album : ${albums}" class="card album-card album-link"
                        th:data-album-id="${album.albumId}" th:data-album-name="${album.albumName}"
                        style="cursor: pointer; padding: 0.8rem;">
                        <img th:src="${album.coverImage != null} ? @{/albums/cover/{id}(id=${album.albumId})} : @{/images/music-placeholder.svg}"
                            onerror="this.src='/images/music-placeholder.svg'" alt="Cover"
                            style="width: 100%; border-radius: 4px; margin-bottom: 0.5rem; aspect-ratio: 1; object-fit: cover;">
                        <h3 th:text="${album.albumName}" style="font-size: 0.9rem; margin: 0;">Album Title</h3>
                        <p th:text="${album.artist != null ? album.artist.artistName : 'Unknown Artist'}"
                            style="color: var(--text-secondary); font-size: 0.75rem; margin: 0.2rem 0;">Artist Name</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Artists Section -->
        <div class="artists-section" style="margin-top: 3rem;">
            <h2
                style="font-size: 1.2rem; border-bottom: 2px solid var(--primary); display: inline-block; margin-bottom: 1rem;">
                Artists</h2>
            <p th:if="${artists == null || artists.empty}">No artists found.</p>
            <div class="artist-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem;">
                <div th:each="artist : ${artists}" class="card artist-card artist-link"
                    th:data-artist-id="${artist.artistId}" th:data-artist-name="${artist.artistName}"
                    style="cursor: pointer; text-align: center; padding: 1rem;">
                    <div
                        style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; margin: 0 auto 0.5rem auto;">
                        <span
                            th:text="${artist.artistName != null ? artist.artistName.substring(0,1).toUpperCase() : 'A'}">A</span>
                    </div>
                    <h3 th:text="${artist.artistName}" style="font-size: 0.9rem; margin: 0;">Artist Name</h3>
                </div>
            </div>
        </div>

        <!-- Album Songs Modal -->
        <div id="albumSongsModal"
            style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; padding: 50px 0;">
            <div class="card" style="width: 100%; max-width: 800px; margin: 0 auto; position: relative; padding: 2rem;">
                <span onclick="document.getElementById('albumSongsModal').style.display='none'"
                    style="position: absolute; right: 20px; top: 20px; cursor: pointer; font-size: 2rem;">&times;</span>

                <div style="display: flex; gap: 2rem; align-items: flex-end; margin-bottom: 2rem;">
                    <img id="modalAlbumCover" src="/images/music-placeholder.svg"
                        style="width: 200px; height: 200px; border-radius: 8px; object-fit: cover; box-shadow: 0 8px 20px rgba(0,0,0,0.4);">
                    <div>
                        <h2 id="modalAlbumName" style="font-size: 2.5rem; margin: 0;">Album Name</h2>
                        <p id="modalAlbumArtist"
                            style="color: var(--text-secondary); font-size: 1.2rem; margin: 0.5rem 0 1.5rem 0;">Artist
                            Name</p>
                        <button id="playAllBtn" class="btn btn-primary"
                            style="padding: 0.8rem 2rem; font-size: 1.1rem; border-radius: 50px;">â–¶ Play All</button>
                    </div>
                </div>

                <div id="modalSongsList">
                    <!-- Songs will be loaded here -->
                </div>
            </div>
        </div>

        <script th:inline="none">
            async function showAlbumSongs(albumId, albumName) {
                const modal = document.getElementById('albumSongsModal');
                const list = document.getElementById('modalSongsList');
                const cover = document.getElementById('modalAlbumCover');
                const name = document.getElementById('modalAlbumName');
                const artistEl = document.getElementById('modalAlbumArtist');
                const playAllBtn = document.getElementById('playAllBtn');

                name.innerText = albumName;
                cover.src = `/songs/cover/${albumId}?type=album`; // Slight hint or just use fallback
                cover.src = `/albums/cover/${albumId}`;
                cover.onerror = () => cover.src = '/images/music-placeholder.svg';
                list.innerHTML = '<p style="text-align: center; padding: 2rem;">Loading songs...</p>';
                modal.style.display = 'block';

                try {
                    const response = await fetch(`/album/${albumId}`);
                    const songs = await response.json();

                    if (songs.length > 0) {
                        artistEl.innerText = songs[0].artist;
                        list.innerHTML = `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="text-align: left; border-bottom: 1px solid var(--glass-border); color: var(--text-secondary);">
                                        <th style="padding: 10px; width: 50px;">#</th>
                                        <th style="padding: 10px;">Title</th>
                                        <th style="padding: 10px; text-align: right;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${songs.map((s, i) => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 10px; color: var(--text-secondary);">${i + 1}</td>
                                            <td style="padding: 10px; font-weight: 500;">${s.title}</td>
                                            <td style="padding: 10px; text-align: right;">
                                                <button class="btn btn-primary play-btn" style="font-size: 0.8rem; padding: 0.4rem 1rem;" 
                                                    data-id="${s.id}" data-title="${s.title.replace(/"/g, '&quot;')}" 
                                                    data-artist="${s.artist.replace(/"/g, '&quot;')}" 
                                                    data-album-id="${s.coverId || 'null'}">Play</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;

                        playAllBtn.onclick = () => {
                            if (songs.length > 0) {
                                Player.playSong(songs[0].id, songs.map(s => ({
                                    id: s.id,
                                    title: s.title,
                                    artist: s.artist,
                                    coverId: s.coverId
                                })));
                                modal.style.display = 'none';
                                App.showToast('Playing album...', 'success');
                            }
                        };
                    } else {
                        list.innerHTML = '<p style="text-align: center; padding: 2rem;">No songs in this album.</p>';
                        artistEl.innerText = '';
                    }
                } catch (err) {
                    list.innerHTML = '<p style="text-align: center; color: #ff4d4d; padding: 2rem;">Failed to load songs.</p>';
                }
            }

            async function showArtistSongs(artistId, artistName) {
                const modal = document.getElementById('albumSongsModal');
                const list = document.getElementById('modalSongsList');
                const cover = document.getElementById('modalAlbumCover');
                const name = document.getElementById('modalAlbumName');
                const artistEl = document.getElementById('modalAlbumArtist');
                const playAllBtn = document.getElementById('playAllBtn');

                name.innerText = artistName;
                artistEl.innerText = "Artist Profile";
                cover.src = '/images/music-placeholder.svg'; // Or special artist image
                list.innerHTML = '<p style="text-align: center; padding: 2rem;">Loading artist songs...</p>';
                modal.style.display = 'block';

                try {
                    const response = await fetch(`/artist/songs/${artistId}`);
                    const songs = await response.json();

                    if (songs.length > 0) {
                        list.innerHTML = `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="text-align: left; border-bottom: 1px solid var(--glass-border); color: var(--text-secondary);">
                                        <th style="padding: 10px; width: 50px;">#</th>
                                        <th style="padding: 10px;">Title</th>
                                        <th style="padding: 10px; text-align: right;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${songs.map((s, i) => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 10px; color: var(--text-secondary);">${i + 1}</td>
                                            <td style="padding: 10px; font-weight: 500;">${s.title}</td>
                                            <td style="padding: 10px; text-align: right;">
                                                <button class="btn btn-primary play-btn" style="font-size: 0.8rem; padding: 0.4rem 1rem;" 
                                                    data-id="${s.id}" data-title="${s.title.replace(/"/g, '&quot;')}" 
                                                    data-artist="${s.artist.replace(/"/g, '&quot;')}" 
                                                    data-album-id="${s.coverId || 'null'}">Play</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;

                        playAllBtn.onclick = () => {
                            Player.playSong(songs[0].id, songs.map(s => ({
                                id: s.id,
                                title: s.title,
                                artist: s.artist,
                                coverId: s.coverId
                            })));
                            modal.style.display = 'none';
                            App.showToast(`Playing songs by ${artistName}...`, 'success');
                        };
                    } else {
                        list.innerHTML = '<p style="text-align: center; padding: 2rem;">No songs found for this artist.</p>';
                    }
                } catch (err) {
                    list.innerHTML = '<p style="text-align: center; color: #ff4d4d; padding: 2rem;">Failed to load artist songs.</p>';
                }
            }

            // Centralized Link Handling for Albums and Artists
            document.addEventListener('click', (e) => {
                const albumLink = e.target.closest('.album-link');
                const artistLink = e.target.closest('.artist-link');

                if (albumLink) {
                    showAlbumSongs(
                        albumLink.getAttribute('data-album-id'),
                        albumLink.getAttribute('data-album-name')
                    );
                } else if (artistLink) {
                    showArtistSongs(
                        artistLink.getAttribute('data-artist-id'),
                        artistLink.getAttribute('data-artist-name')
                    );
                }
            });
        </script>
    </div>

    <!-- Enhanced Music Player -->
    <div th:replace="~{artist/dashboard :: #musicPlayer}"></div>

    <script th:src="@{/js/player.js}"></script>
</body>

</html>